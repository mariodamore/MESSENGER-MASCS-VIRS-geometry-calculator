## General description

**This repository is Work In Progress**

This repository contains the code used to calculate the updated geometry for the [NASA MESSENGER](https://www.nasa.gov/mission_pages/messenger/main/index.html) ([JPL](https://messenger.jhuapl.edu/) link) Mercury Atmospheric and Surface Composition Spectrometer ([MASCS](https://lasp.colorado.edu/home/instruments/mascs/)) instrument, VIRS channel.

This work was presented at [Lunar and Planetary Science Conference 2023](https://www.hou.usra.edu/meetings/lpsc2023/) (LPSC), abstract number #2048.

- Authors : D'Amore M.* Helbert J. Maturilli A. Domingue D. L.
- Title : [MESSENGER MASCS VIRS Updated Geometry #2048](https://www.hou.usra.edu/meetings/lpsc2023/pdf/2048.pdf)
- Abstract : MASCS instrument was onboard the NASA MESSENGER. MASCS acquired reflectance with an average 5-km scale. We computed MASCS geometries with an added DTM model.

If you use this software, please cite it with [DOI: 10.5281/zenodo.7778374 ](https://doi.org/10.5281/zenodo.7778374) 

[![DOI](https://www.zenodo.org/badge/612290628.svg)](https://www.zenodo.org/badge/latestdoi/612290628)

## Summary

The points I tried to address:

1. PDS data contains only center, trailing, leading and lateral points of the elongated Field Of View (FOV).
2. PDS paramters are calculated only at the central point.
3. PDS data contain some geometrical paramters, but omit useful one like i.e. local time (useful proxy for the surface temperature). 
4. PDS data were calculated approximating Mercury to an ellipsoid. I used a SPICE DTM derived from MESSENGER Mercury Laser Altimeter (MLA) to 7 pixels per degree data processed and generated by [ESA SPICE Service (ESS)](https://s2e2.cosmos.esa.int/bitbucket/scm/spice_kernels/esa_generic)

ESA have a [more detailed tiled version](https://spiftp.esac.esa.int/data/SPICE/esa_generic/kernels/dsk/tiled/) at full 665m resolution, but it is harder to use (SPICE limits to 8M polygons per model file).
Thanks to Alfredo Escalante Lopez and Thomas Cornet (ESA).

Original data from USGS > [Mercury MESSENGER Global DEM 665m v2](https://astrogeology.usgs.gov/search/map/Mercury/Topography/MESSENGER/Mercury_Messenger_USGS_DEM_Global_665m_v2)

## Quickstart

An example run is in `notebooks/SPICE_MASCS.ipynb`.

To run the notebooks one need to :

1. Install all the dependencies in `requirements.txt` .I suggest use a [conda environment](https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html) to deal with the geo tools install like gdal etc. I suggest [miniconda](https://docs.conda.io/en/latest/miniconda.html) or [conda-forge/miniforge: A conda-forge distribution.](https://github.com/conda-forge/miniforge) nowadays.
2. Download (some) MASCS data from [UVVS and VIRS CDRs and DDRs, version 2 (MESSMAS_2101)](https://pds-geosciences.wustl.edu/missions/messenger/mascs.htm). A test file is available in [data/raw/test/mess-e_v_h-mascs-3-virs-cdr-caldata-v1/messmas_2101/data/ddr/orb/virs/mascs20110812/vis](/data/raw/test/mess-e_v_h-mascs-3-virs-cdr-caldata-v1/messmas_2101/data/ddr/orb/virs/mascs20110812/vis) and it is already in the notebook.
3. Download the [SPICE data for Messenger mission](https://naif.jpl.nasa.gov/pub/naif/pds/data/mess-e_v_h-spice-6-v1.0/messsp_1000/) (~45GB). it is possible to subset the data for a small time window [here](https://naif.jpl.nasa.gov/cgi-bin/subsetds.pl?dataset=mess-e_v_h-spice-6-v1.0/messsp_1000). [wget_messsp_1000_110812_110812.sh](/data/raw/spice_kernels/NASA/wget_messsp_1000_110812_110812.sh) script downloads the minimal data to run the notebook (~950MB).
4. Download ESA Mercury 3D model from [esa_generic](https://s2e2.cosmos.esa.int/bitbucket/projects/spice_kernels/repos/esa_generic/browse), Mercury data are in `kernels/dsk/planets`.  [clone_ESA_DSK.sh](data/raw/spice_kernels/clone_ESA_DSK.sh) script will clone the data with git.
5. Adapt the PATH in the SPICE metakernel from 3, example metakernel adapted is already in [msgr_2011_v10_110812_110812.tm](data/raw/spice_kernels/NASA/msgr_2011_v10_110812_110812.tm).
6. Add ESA 3D model to 3. i.e.: create  a symlink from `ESA/kernels/dsk/planets/dsk` to main directory of `messsp_1000` SPICE kernel. Example code to do this is already in the notebook. 
7. Add the new 3D model in metakernel like `'$KERNELS/dsk/planets/mercury_m002_mes_v01.bds'`. Example metakernel is already adapted.
8. Install this package `msgmascsgeo` with `make install_develop` or `pip install --editable` .
9. Run the notebook or your code.
10. (maybe) enjoy the result.

###  Directory structure

The directory structure was created automatically with the template [cookiecutter-data-science](https://github.com/drivendata/cookiecutter-data-science#readme) of [cookiecutter](https://cookiecutter.readthedocs.io/en/latest/installation.html) tool.

Basic concepts are listed here ([extended](https://github.com/drivendata/cookiecutter-data-science/blob/master/docs/docs/index.md)) :

- **Data is immutable**. *Don't ever edit your raw data*, especially not manually, and especially not in Excel. Don't overwrite your raw data. Don't save multiple versions of the raw data. Treat the data (and its format) as immutable.
- **Notebooks are for exploration and communication**. Follow a naming convention that shows the owner and the order the analysis was done in.  Refactor the good parts. Don't write code to do the same task in multiple notebooks.
- **Analysis is a directed acyclic graph (DAG)**. Often in an analysis you have long-running steps that preprocess data or train models. If these steps have been run already (and you have stored the output somewhere like the data/interim directory), you don't want to wait to rerun them every time.
- **Keep secrets and configuration out of version control**. You really don't want to leak your AWS secret key or Postgres username and password on Github
- **Be conservative in changing the default folder structure**. To keep this structure broadly applicable for many different kinds of projects, we think the best approach is to be liberal in changing the folders around for your project, but be conservative in changing the default structure for all projects.

```
├── LICENSE
├── Makefile           <- Makefile with commands like `make data` or `make train`
├── README.md          <- The top-level README for developers using this project.
├── data
│   ├── external       <- Data from third party sources.
│   ├── interim        <- Intermediate data that has been transformed.
│   ├── processed      <- The final, canonical data sets for modeling.
│   └── raw            <- The original, immutable data dump.
│       └── test       <- minimal dataset for example and test purpose
│
├── docs               <- A default Sphinx project; see sphinx-doc.org for details
│
├── notebooks          <- Jupyter notebooks. 
│
├── references         <- Data dictionaries, manuals, and all other explanatory materials.
│
├── reports            <- Generated analysis as HTML, PDF, LaTeX, etc.
│   └── figures        <- Generated graphics and figures to be used in reporting
│
├── requirements.txt   <- The requirements file for reproducing the analysis environment, e.g.
│                         generated with `pip freeze > requirements.txt`
│
├── pyproject.toml     <- makes project pip installable (pip install -e .) so msgmascsgeo can be imported
└── msgmascsgeo        <- Source code for use in this project.
    ├── __init__.py    <- Makes src a Python module
    │
    └── spicefuncs.py  <- Scripts to calculate geometries.

```
